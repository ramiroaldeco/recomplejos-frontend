<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Alta de Complejo (Onboarding)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--prim:#0b8457}
    body{font-family:Segoe UI,Arial,sans-serif;background:#f6f7fb;margin:0}
    header{background:var(--prim);color:#fff;padding:14px 18px}
    .wrap{max-width:1000px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.07);padding:20px}
    h1,h2{margin:0 0 10px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    label{font-weight:600}
    input,textarea,select{width:100%;padding:10px;border:1px solid #e2e5ec;border-radius:8px;background:#fbfbfd}
    button{background:var(--prim);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer}
    .card{border:1px solid #eee;border-radius:12px;padding:14px;margin:14px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef2f7;border-radius:999px;padding:4px 10px;margin:2px 6px 2px 0}
    .ok{color:#0b8457;font-weight:600}
    .err{color:#b00020;font-weight:600}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e8e8e8;padding:8px;text-align:center}
    th{background:var(--prim);color:#fff}
    small{color:#555}
    pre{white-space:pre-wrap;background:#fbfbfd;border:1px solid #eee;padding:10px;border-radius:8px;max-height:260px;overflow:auto}
  </style>
</head>
<body>
  <header><h1>Alta de Complejo</h1></header>

  <div class="wrap">
    <!-- 1) Identificación -->
    <div class="card">
      <h2>1) Identificación</h2>
      <div class="grid g2">
        <div>
          <label>Slug / ID único (sin espacios)</label>
          <input id="id" placeholder="ej: elbosque, lamasia" />
          <small>Usá solo letras, números, guiones y guion bajo. Este ID se usa en todo el sistema.</small>
        </div>
        <div>
          <label>Clave del dueño (para login)</label>
          <input id="clave" type="password" placeholder="Contraseña del dueño" />
        </div>
      </div>
    </div>

    <!-- 2) Datos públicos -->
    <div class="card">
      <h2>2) Datos públicos</h2>
      <div class="grid g2">
        <div>
          <label>Nombre</label>
          <input id="nombre" placeholder="Complejo El Bosque" />
        </div>
        <div>
          <label>Ciudad</label>
          <input id="ciudad" placeholder="Hernando, Córdoba" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Mapa (iframe embebido)</label>
        <textarea id="maps" rows="3" placeholder="Pegar el iframe de Google Maps"></textarea>
      </div>

      <div style="margin-top:10px">
        <label>Servicios</label>
        <div id="servicios" class="row"></div>
      </div>
    </div>

    <!-- 3) Horarios -->
    <div class="card">
      <h2>3) Horarios por día</h2>
      <table>
        <thead><tr><th>Día</th><th>Desde</th><th>Hasta</th></tr></thead>
        <tbody id="tbodyHorarios"></tbody>
      </table>
    </div>

    <!-- 4) Canchas -->
    <div class="card">
      <h2>4) Canchas</h2>
      <div id="canchas"></div>
      <div style="margin-top:8px"><button type="button" id="btnAgregarCancha">+ Agregar cancha</button></div>
    </div>

    <!-- 5) Conexión con Mercado Pago (OAuth) -->
    <div class="card">
      <h2>5) Conectar con Mercado Pago (OAuth)</h2>
      <p id="mpEstado">Chequeando estado...</p>
      <div class="row">
        <button id="btnConectar" type="button" style="display:none">Conectar con Mercado Pago</button>
        <button id="btnProbarMP" type="button" style="display:none">Probar cobro $10</button>
      </div>
      <small>
        Recomendado: no te pedimos claves ni tokens. Autorizás desde Mercado Pago y podrás revocar cuando quieras.
        La seña que paguen tus clientes va directo a tu cuenta.
      </small>
    </div>

    <!-- 6) Contacto del dueño (para notificaciones) -->
    <div class="card">
      <h2>6) Contacto del dueño (opcional, recomendado)</h2>
      <div class="grid g2">
        <div>
          <label>Email del dueño</label>
          <input id="emailDueño" type="email" placeholder="dueno@ejemplo.com">
        </div>
        <div>
          <label>WhatsApp del dueño (con país, ej. 549351xxxxxxx)</label>
          <input id="whatsappDueño" type="tel" placeholder="549351XXXXXXX">
        </div>
      </div>
      <small>Si los completás, el sistema puede enviarte notificaciones cuando se confirme una reserva.</small>
    </div>

    <!-- Guardar datos -->
    <div class="card">
      <div class="row">
        <button type="button" id="btnGuardar">Guardar datos del complejo</button>
        <div id="msgDatos"></div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="card">
      <h2>Resumen (lo que se enviará a <code>datos_complejos.json</code>)</h2>
      <pre id="preview"></pre>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const backend = "https://recomplejos-backend.onrender.com";

/* ====== CONSTANTES UI ====== */
const DIAS = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
const SERVS = ["Duchas","Vestuarios","Quincho","Parrilla","Wifi","Bar","Buffet","Baños","Estacionamiento"];

/* ====== HELPERS UI ====== */
const $ = sel => document.querySelector(sel);
function opt(h){ const o=document.createElement("option"); o.value=o.textContent=h; return o; }

function armarHorarios() {
  const tb = $("#tbodyHorarios"); tb.innerHTML = "";
  for (const d of DIAS) {
    const tr = document.createElement("tr");
    const tdDia = document.createElement("td"); tdDia.textContent = d; tr.appendChild(tdDia);
    const tdDesde = document.createElement("td"); const tdHasta = document.createElement("td");
    const s1=document.createElement("select"), s2=document.createElement("select");
    for (let h=0; h<=23; h++) { const hh = String(h).padStart(2,"0")+":00"; s1.appendChild(opt(hh)); s2.appendChild(opt(hh)); }
    s1.value="18:00"; s2.value="23:00";
    tdDesde.appendChild(s1); tdHasta.appendChild(s2);
    tr.appendChild(tdDesde); tr.appendChild(tdHasta);
    tb.appendChild(tr);
  }
}

function armarServicios() {
  const cont = $("#servicios"); cont.innerHTML = "";
  for (const s of SERVS) {
    const label = document.createElement("label"); label.className="pill";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.value=s;
    label.appendChild(cb); label.append(" "+s);
    cont.appendChild(label);
  }
}

function agregarCancha(val={}) {
  const div = document.createElement("div");
  div.className="card";
  div.innerHTML = `
    <div class="grid g3">
      <div><label>Nombre</label><input class="c-nombre" placeholder="Fútbol 5" value="${val.nombre||""}"></div>
      <div><label>Precio total</label><input class="c-precioTotal" type="number" min="0" value="${val.precioTotal||""}"></div>
      <div><label>Precio por jugador</label><input class="c-precioJugador" type="number" min="0" value="${val.precioPorJugador||""}"></div>
    </div>
    <div class="grid g3" style="margin-top:8px">
      <div><label>Jugadores</label><input class="c-jugadores" type="number" min="0" value="${val.jugadores||""}"></div>
      <div><label>Seña</label><input class="c-senia" type="number" min="0" value="${val.senia||""}"></div>
      <div style="display:flex;align-items:end"><button type="button" class="btnEliminar">Eliminar</button></div>
    </div>`;
  $("#canchas").appendChild(div);
  div.querySelector(".btnEliminar").onclick = () => { div.remove(); refrescarPreview(); };
}

function leerCanchas() {
  const arr = [];
  document.querySelectorAll("#canchas .card").forEach(card=>{
    arr.push({
      nombre: card.querySelector(".c-nombre").value.trim(),
      precioTotal: card.querySelector(".c-precioTotal").value.trim(),
      precioPorJugador: card.querySelector(".c-precioJugador").value.trim(),
      jugadores: card.querySelector(".c-jugadores").value.trim(),
      senia: card.querySelector(".c-senia").value.trim()
    });
  });
  return arr;
}

function validarSlug(id) {
  return /^[a-zA-Z0-9_-]+$/.test(id);
}

function payloadDatos() {
  const horarios = {};
  document.querySelectorAll("#tbodyHorarios tr").forEach(tr=>{
    const dia = tr.children[0].textContent;
    const desde = tr.children[1].querySelector("select").value;
    const hasta = tr.children[2].querySelector("select").value;
    horarios[dia] = { desde, hasta };
  });
  const servicios = Array.from(document.querySelectorAll("#servicios input:checked")).map(cb=>cb.value);
  const id = $("#id").value.trim();

  return {
    [id]: {
      clave: $("#clave").value.trim(),
      nombre: $("#nombre").value.trim(),
      ciudad: $("#ciudad").value.trim(),
      maps: $("#maps").value.trim(),
      servicios,
      horarios,
      imagenes: [],
      canchas: leerCanchas(),
      emailDueño: $("#emailDueño")?.value.trim() || "",
      whatsappDueño: $("#whatsappDueño")?.value.trim() || ""
    }
  };
}

function refrescarPreview() {
  $("#preview").textContent = JSON.stringify(payloadDatos(), null, 2);
}

/* ====== GUARDAR DATOS ====== */
async function idDisponible(id) {
  const actuales = await fetch(`${backend}/datos_complejos?t=${Date.now()}`).then(r => r.json());
  return !actuales[id];
}

async function guardarDatos() {
  const id = $("#id").value.trim();
  const msg = $("#msgDatos"); 
  msg.textContent = ""; msg.className = "";

  if (!id) { msg.textContent = "Falta el ID"; msg.className = "err"; return; }
  if (!validarSlug(id)) { msg.textContent = "ID inválido. Usá solo letras, números, - y _"; msg.className = "err"; return; }

  // Si ya existe, avisamos que se actualizará
  const existe = !(await idDisponible(id));
  const actuales = await fetch(`${backend}/datos_complejos?t=${Date.now()}`).then(r => r.json());
  const nuevo = payloadDatos();
  const merged = { ...actuales, ...nuevo };

  await fetch(`${backend}/guardarDatos`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(merged)
  });

  msg.textContent = existe ? "Datos actualizados ✅" : "Datos del complejo guardados ✅";
  msg.className = "ok";

  // Guardar localmente el ID para la sección OAuth
  localStorage.setItem("complejoId", id);
  pintarEstadoMP();
  <script>
// al final del init, donde ya llamás a pintarEstadoMP()
window.addEventListener("load", () => {
  const q = new URLSearchParams(location.search);
  const id = q.get("complejo");
  if (id) { const idEl = document.querySelector("#id"); if (idEl && !idEl.value) idEl.value = id; }
  pintarEstadoMP();

  if (q.get("mp") === "ok") {
    const msg = document.getElementById("msgDatos");
    if (msg) { msg.textContent = "Mercado Pago conectado ✅ (no olvides Guardar datos)"; msg.className = "ok"; }
  }
});
</script>

}

/* ====== OAUTH MERCADO PAGO ====== */
function getComplejoId() {
  // intenta por query ?complejo=, luego por input, luego por localStorage
  const byQuery = new URLSearchParams(location.search).get("complejo") || "";
  if (byQuery) return byQuery.trim();
  const byInput = $("#id")?.value?.trim();
  if (byInput) return byInput;
  return localStorage.getItem("complejoId") || "";
}

async function pintarEstadoMP() {
  const complejoId = getComplejoId();
  const estadoEl = $("#mpEstado");
  const btnCon = $("#btnConectar");
  const btnTest = $("#btnProbarMP");
  if (!estadoEl || !btnCon || !btnTest) return;

  if (!complejoId) {
    estadoEl.textContent = "Primero completá el ID/slug del complejo (Sección 1).";
    btnCon.style.display = "none";
    btnTest.style.display = "none";
    return;
  }

  try {
    const r = await fetch(`${backend}/mp/estado?complejoId=${encodeURIComponent(complejoId)}`);
    const dj = await r.json();
    if (dj.ok && dj.conectado) {
      estadoEl.textContent = "🟢 Mercado Pago conectado";
      btnCon.style.display = "none";
      btnTest.style.display = "inline-block";
    } else {
      estadoEl.textContent = "🔴 Mercado Pago NO conectado";
      btnCon.style.display = "inline-block";
      btnTest.style.display = "none";
    }
  } catch {
    estadoEl.textContent = "No se pudo chequear el estado de MP.";
    btnCon.style.display = "inline-block";
    btnTest.style.display = "none";
  }
}

function conectarMP() {
  const complejoId = getComplejoId();
  if (!complejoId) return alert("Completá el ID/slug del complejo primero.");
  localStorage.setItem("complejoId", complejoId);
  location.href = `${backend}/mp/conectar?complejoId=${encodeURIComponent(complejoId)}`;
}

async function probarCobro() {
  const complejoId = getComplejoId();
  if (!complejoId) return alert("Completá el ID/slug del complejo primero.");
  try {
    const r = await fetch(`${backend}/crear-preferencia`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        complejoId,
        clave: `test-${Date.now()}`,
        titulo: "Prueba de seña",
        precio: 10,
        nombre: "Prueba",
        telefono: "000"
      })
    });
    const dj = await r.json();
    if (dj?.init_point) {
      location.href = dj.init_point;
    } else {
      console.log(dj);
      alert(dj?.error || "No se pudo generar la preferencia de prueba.");
    }
  } catch (e) {
    console.error(e);
    alert("Error creando preferencia de prueba.");
  }
}

/* ====== EVENTOS ====== */
document.getElementById("btnAgregarCancha").onclick = () => { agregarCancha(); };
document.getElementById("btnGuardar").onclick = guardarDatos;
document.getElementById("btnConectar").onclick = conectarMP;
document.getElementById("btnProbarMP").onclick = probarCobro;

document.addEventListener("input", e=>{
  if (["id","clave","nombre","ciudad","maps","emailDueño","whatsappDueño"].includes(e.target.id)) {
    refrescarPreview();
    if (e.target.id === "id") {
      localStorage.setItem("complejoId", e.target.value.trim());
      pintarEstadoMP();
    }
  }
});
document.addEventListener("change", e=>{
  if (e.target.closest("#servicios") || e.target.closest("#tbodyHorarios") || e.target.closest("#canchas")) refrescarPreview();
});
document.getElementById("canchas").addEventListener("input", refrescarPreview);

/* ====== INIT ====== */
armarHorarios();
armarServicios();
agregarCancha();        // una cancha de ejemplo
refrescarPreview();
window.addEventListener("load", () => {
  // si viene ?complejo= en la URL, lo llena en el input
  const q = new URLSearchParams(location.search).get("complejo");
  if (q) { const idEl = $("#id"); if (idEl && !idEl.value) idEl.value = q; }
  pintarEstadoMP();
});
</script>
</body>
</html>




