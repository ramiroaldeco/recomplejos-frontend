<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Alta de Complejo (Onboarding)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--prim:#0b8457}
    body{font-family:Segoe UI,Arial,sans-serif;background:#f6f7fb;margin:0}
    header{background:var(--prim);color:#fff;padding:14px 18px}
    .wrap{max-width:1000px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.07);padding:20px}
    h1,h2{margin:0 0 10px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    label{font-weight:600}
    input,textarea,select{width:100%;padding:10px;border:1px solid #e2e5ec;border-radius:8px;background:#fbfbfd}
    input[type="tel"]{inputmode:numeric;}
    button{background:var(--prim);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer}
    .card{border:1px solid #eee;border-radius:12px;padding:14px;margin:14px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;background:#eef2f7;border-radius:999px;padding:4px 10px;margin:2px 6px 2px 0}
    .ok{color:#0b8457;font-weight:600}
    .err{color:#b00020;font-weight:600}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e8e8e8;padding:8px;text-align:center}
    th{background:var(--prim);color:#fff}
    small{color:#555}
    pre{white-space:pre-wrap;background:#fbfbfd;border:1px solid #eee;padding:10px;border-radius:8px;max-height:260px;overflow:auto}

    /* ===== Responsive m√≥vil - onboarding.html ===== */
    @media (max-width: 992px) {
      .wrap { margin: 12px; padding: 14px; }
      .grid.g2, .grid.g3 { grid-template-columns: 1fr !important; }
      table { font-size: 14px; }
      th, td { padding: 6px; }
      .row { gap: 6px; }
    }
    @media (max-width: 600px) {
      header { padding: 12px 14px; }
      .card { padding: 12px; }
      input, textarea, select { padding: 9px; }
      button { width: 100%; padding: 12px; }
      pre { max-height: 220px; }
      .footer-save{position:sticky;bottom:0;background:#fff;padding:10px;border-top:1px solid #eee;box-shadow:0 -6px 18px rgba(0,0,0,.06)}
    }
  </style>
</head>
<body>
  <header><h1>Alta de Complejo</h1></header>

  <div class="wrap">
    <!-- 1) Identificaci√≥n -->
    <div class="card">
      <h2>1) Identificaci√≥n</h2>
      <div class="grid g2">
        <div>
          <label>Slug / ID √∫nico (sin espacios)</label>
          <input id="id" placeholder="ej: elbosque, lamasia" />
          <small>Us√° solo letras, n√∫meros, guiones y guion bajo. Este ID se usa en todo el sistema.</small>
        </div>
        <div>
          <label>Clave del due√±o (para login)</label>
          <input id="clave" type="password" placeholder="Contrase√±a del due√±o" />
        </div>
      </div>
    </div>

    <!-- 2) Datos p√∫blicos -->
    <div class="card">
      <h2>2) Datos p√∫blicos</h2>
      <div class="grid g2">
        <div>
          <label>Nombre</label>
          <input id="nombre" placeholder="Complejo El Bosque" />
        </div>
        <div>
          <label>Ciudad</label>
          <input id="ciudad" placeholder="Hernando, C√≥rdoba" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Mapa (iframe embebido)</label>
        <textarea id="maps" rows="3" placeholder="Pegar el iframe de Google Maps"></textarea>
      </div>

      <div style="margin-top:10px">
        <label>Servicios</label>
        <div id="servicios" class="row"></div>
      </div>
    </div>

    <!-- 3) Horarios -->
    <div class="card">
      <h2>3) Horarios por d√≠a</h2>
      <table>
        <thead><tr><th>D√≠a</th><th>Desde</th><th>Hasta</th></tr></thead>
        <tbody id="tbodyHorarios"></tbody>
      </table>
    </div>

    <!-- 4) Canchas -->
    <div class="card">
      <h2>4) Canchas</h2>
      <div id="canchas"></div>
      <div style="margin-top:8px"><button type="button" id="btnAgregarCancha">+ Agregar cancha</button></div>
    </div>

    <!-- 5) Conexi√≥n con Mercado Pago (OAuth) -->
    <div class="card">
      <h2>5) Conectar con Mercado Pago (OAuth)</h2>
      <p id="mpEstado">Chequeando estado...</p>
      <div class="row">
        <button id="btnConectar" type="button" style="display:none">Conectar con Mercado Pago</button>
        <button id="btnProbarMP" type="button" style="display:none">Probar cobro $10</button>
      </div>
      <small>
        Recomendado: no te pedimos claves ni tokens. Autoriz√°s desde Mercado Pago y podr√°s revocar cuando quieras.
        La se√±a que paguen tus clientes va directo a tu cuenta.
      </small>
    </div>

    <!-- 6) Contacto del due√±o (para notificaciones) -->
    <div class="card">
      <h2>6) Contacto del due√±o (opcional, recomendado)</h2>
      <div class="grid g2">
        <div>
          <label>Email del due√±o</label>
          <input id="emailDue√±o" type="email" placeholder="dueno@ejemplo.com">
        </div>
        <div>
          <label>WhatsApp del due√±o (con pa√≠s, ej. 549351xxxxxxx)</label>
          <input id="whatsappDue√±o" type="tel" placeholder="549351XXXXXXX" inputmode="numeric" pattern="[0-9]*">
        </div>
      </div>
      <small>Si los complet√°s, el sistema puede enviarte notificaciones cuando se confirme una reserva.</small>
    </div>

    <!-- Guardar -->
    <div class="card footer-save">
      <div class="row" style="width:100%">
        <button type="button" id="btnGuardar" style="flex:1">Guardar datos del complejo</button>
        <div id="msgDatos" style="min-width:240px"></div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="card">
      <h2>Resumen (lo que se guardar√°)</h2>
      <pre id="preview"></pre>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const backend = "https://recomplejos-backend.onrender.com";

/* ====== CONSTANTES UI ====== */
const DIAS = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
const SERVS = ["Duchas","Vestuarios","Quincho","Parrilla","Wifi","Bar","Buffet","Ba√±os","Estacionamiento"];

/* ====== HELPERS UI ====== */
const $ = sel => document.querySelector(sel);
function opt(h){ const o=document.createElement("option"); o.value=o.textContent=h; return o; }

function armarHorarios() {
  const tb = $("#tbodyHorarios"); tb.innerHTML = "";
  for (const d of DIAS) {
    const tr = document.createElement("tr");
    const tdDia = document.createElement("td"); tdDia.textContent = d; tr.appendChild(tdDia);
    const tdDesde = document.createElement("td"); const tdHasta = document.createElement("td");
    const s1=document.createElement("select"), s2=document.createElement("select");
    for (let h=0; h<=23; h++) { const hh = String(h).padStart(2,"0")+":00"; s1.appendChild(opt(hh)); s2.appendChild(opt(hh)); }
    s1.value="18:00"; s2.value="23:00";
    tdDesde.appendChild(s1); tdHasta.appendChild(s2);
    tr.appendChild(tdDesde); tr.appendChild(tdHasta);
    tb.appendChild(tr);
  }
}

function armarServicios() {
  const cont = $("#servicios"); cont.innerHTML = "";
  for (const s of SERVS) {
    const label = document.createElement("label"); label.className="pill";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.value=s;
    label.appendChild(cb); label.append(" "+s);
    cont.appendChild(label);
  }
}

function agregarCancha(val={}) {
  const div = document.createElement("div");
  div.className="card";
  div.innerHTML = `
    <div class="grid g3">
      <div><label>Nombre</label><input class="c-nombre" placeholder="F√∫tbol 5" value="${val.nombre||""}"></div>
      <div><label>Precio total</label><input class="c-precioTotal" type="number" min="0" value="${val.precioTotal||""}"></div>
      <div><label>Precio por jugador</label><input class="c-precioJugador" type="number" min="0" value="${val.precioPorJugador||""}"></div>
    </div>
    <div class="grid g3" style="margin-top:8px">
      <div><label>Jugadores</label><input class="c-jugadores" type="number" min="0" value="${val.jugadores||""}"></div>
      <div><label>Se√±a</label><input class="c-senia" type="number" min="0" value="${val.senia||""}"></div>
      <div style="display:flex;align-items:end"><button type="button" class="btnEliminar">Eliminar</button></div>
    </div>`;
  $("#canchas").appendChild(div);
  div.querySelector(".btnEliminar").onclick = () => { div.remove(); refrescarPreview(); saveDraft(); };
  div.addEventListener("input", ()=>{ refrescarPreview(); saveDraft(); });
}

function leerCanchas() {
  const arr = [];
  document.querySelectorAll("#canchas .card").forEach(card=>{
    arr.push({
      nombre: card.querySelector(".c-nombre").value.trim(),
      precioTotal: card.querySelector(".c-precioTotal").value.trim(),
      precioPorJugador: card.querySelector(".c-precioJugador").value.trim(),
      jugadores: card.querySelector(".c-jugadores").value.trim(),
      senia: card.querySelector(".c-senia").value.trim()
    });
  });
  return arr;
}

function validarSlug(id) {
  return /^[a-zA-Z0-9_-]+$/.test(id);
}

function payloadDesdeFormulario() {
  const horarios = {};
  document.querySelectorAll("#tbodyHorarios tr").forEach(tr=>{
    const dia = tr.children[0].textContent;
    const desde = tr.children[1].querySelector("select").value;
    const hasta = tr.children[2].querySelector("select").value;
    horarios[dia] = { desde, hasta };
  });
  const servicios = Array.from(document.querySelectorAll("#servicios input:checked")).map(cb=>cb.value);
  const id = $("#id").value.trim();

  return {
    [id]: {
      clave: $("#clave").value.trim(),
      nombre: $("#nombre").value.trim(),
      ciudad: $("#ciudad").value.trim(),
      maps: $("#maps").value.trim(),
      servicios,
      horarios,
      imagenes: [],
      canchas: leerCanchas(),
      emailDue√±o: $("#emailDue√±o")?.value.trim() || "",
      whatsappDue√±o: $("#whatsappDue√±o")?.value.trim() || ""
    }
  };
}

function refrescarPreview() {
  $("#preview").textContent = JSON.stringify(payloadDesdeFormulario(), null, 2);
}

/* ====== DRAFT (auto-guardado local) ====== */
const DRAFT_KEY = "onboarding-draft";

function saveDraft(){
  try { localStorage.setItem(DRAFT_KEY, JSON.stringify(payloadDesdeFormulario())); } catch {}
}
function loadDraft(){
  try {
    const raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);
    completarFormularioDesde(obj);
  } catch {}
}
function clearDraft(){ try{ localStorage.removeItem(DRAFT_KEY); }catch{} }

function completarFormularioDesde(obj){
  const id = Object.keys(obj||{})[0]; if(!id) return;
  const d = obj[id];

  $("#id").value = id || "";
  $("#clave").value = d.clave || "";
  $("#nombre").value = d.nombre || "";
  $("#ciudad").value = d.ciudad || "";
  $("#maps").value = d.maps || "";

  // servicios
  (d.servicios || []).forEach(s=>{
    const cb = Array.from(document.querySelectorAll("#servicios input")).find(x=>x.value===s);
    if (cb) cb.checked = true;
  });

  // horarios
  if (d.horarios){
    document.querySelectorAll("#tbodyHorarios tr").forEach(tr=>{
      const dia = tr.children[0].textContent;
      const desde = tr.children[1].querySelector("select");
      const hasta = tr.children[2].querySelector("select");
      if (d.horarios[dia]){
        desde.value = d.horarios[dia].desde || desde.value;
        hasta.value = d.horarios[dia].hasta || hasta.value;
      }
    });
  }

  // canchas
  $("#canchas").innerHTML = "";
  (d.canchas || []).forEach(c=>agregarCancha(c));

  // contacto
  $("#emailDue√±o").value = d.emailDue√±o || "";
  $("#whatsappDue√±o").value = d.whatsappDue√±o || "";

  refrescarPreview();
}

/* ====== GUARDAR DATOS (DB) ====== */
async function guardarDatos(silencioso=false) {
  const id = $("#id").value.trim();
  const msg = $("#msgDatos");
  if (!silencioso){ msg.textContent = ""; msg.className = ""; }

  if (!id) { if(!silencioso){msg.textContent="Falta el ID"; msg.className="err";} return false; }
  if (!validarSlug(id)) { if(!silencioso){msg.textContent="ID inv√°lido. Us√° solo letras, n√∫meros, - y _"; msg.className="err";} return false; }

  // Guardar localmente el ID para la secci√≥n OAuth
  localStorage.setItem("complejoId", id);

  try {
    // Traigo lo actual del backend (con cache-buster)
    const actuales = await fetch(`${backend}/datos_complejos?t=${Date.now()}`).then(r => r.json());
    const nuevo = payloadDesdeFormulario();
    const merged = { ...actuales, ...nuevo };

    // Guardo en el backend
    const resp = await fetch(`${backend}/guardarDatos`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(merged)
    });

    if (!resp.ok) {
      if(!silencioso){ msg.textContent = "No se pudo guardar en el servidor (HTTP " + resp.status + ")."; msg.className = "err"; }
      return false;
    }

    // Verificaci√≥n inmediata
    const verif = await fetch(`${backend}/datos_complejos?t=${Date.now()}`).then(r => r.json());
    const ok = Boolean(verif[id]);
    if (!silencioso){
      msg.textContent = ok ? "Datos del complejo guardados ‚úÖ" :
                             "Guardado enviado pero el servidor no refleja el cambio.";
      msg.className = ok ? "ok" : "err";
    }

    // persistencia local
    saveDraft();
    refrescarPreview();
    pintarEstadoMP();
    return ok;
  } catch (e) {
    console.error(e);
    if(!silencioso){ msg.textContent = "Error de red/JS al guardar."; msg.className = "err"; }
    return false;
  }
}

/* ====== OAUTH MERCADO PAGO ====== */
function getComplejoId() {
  const byQuery = new URLSearchParams(location.search).get("complejo") || "";
  if (byQuery) return byQuery.trim();
  const byInput = $("#id")?.value?.trim();
  if (byInput) return byInput;
  return localStorage.getItem("complejoId") || "";
}

async function pintarEstadoMP() {
  const complejoId = getComplejoId();
  const estadoEl = $("#mpEstado");
  const btnCon = $("#btnConectar");
  const btnTest = $("#btnProbarMP");
  if (!estadoEl || !btnCon || !btnTest) return;

  if (!complejoId) {
    estadoEl.textContent = "Primero complet√° el ID/slug del complejo (Secci√≥n 1).";
    btnCon.style.display = "none";
    btnTest.style.display = "none";
    return;
  }

  try {
    const r = await fetch(`${backend}/mp/estado?complejoId=${encodeURIComponent(complejoId)}`);
    const dj = await r.json();
    if (dj.ok && dj.conectado) {
      estadoEl.textContent = "üü¢ Mercado Pago conectado";
      btnCon.style.display = "inline-block";
      btnCon.textContent = "Reconectar";
      btnTest.style.display = "inline-block";
    } else {
      estadoEl.textContent = "üî¥ Mercado Pago NO conectado";
      btnCon.style.display = "inline-block";
      btnCon.textContent = "Conectar con Mercado Pago";
      btnTest.style.display = "none";
    }
  } catch {
    estadoEl.textContent = "No se pudo chequear el estado de MP.";
    btnCon.style.display = "inline-block";
    btnCon.textContent = "Conectar con Mercado Pago";
    btnTest.style.display = "none";
  }
}

async function conectarMP() {
  const complejoId = getComplejoId();
  if (!complejoId) return alert("Complet√° el ID/slug del complejo primero.");

  // 1) guardar en BD (silencioso)
  const ok = await guardarDatos(true);
  saveDraft();

  // 2) abrir OAuth (misma pesta√±a; si prefer√≠s en nueva, us√° window.open)
  if (ok) {
    location.href = `${backend}/mp/conectar?complejoId=${encodeURIComponent(complejoId)}`;
  } else {
    alert("No se pudo guardar los datos antes de conectar MP.");
  }
}

/* ====== NUEVO: Probar cobro con cancha/fecha/hora reales ====== */
function tomarPrimeraCancha() {
  const card = document.querySelector("#canchas .card");
  if (!card) return null;
  const nombre = card.querySelector(".c-nombre")?.value.trim();
  const senia  = Number(card.querySelector(".c-senia")?.value.trim() || "0");
  return nombre ? { nombre, senia } : null;
}

function fechaManiana() {
  const d = new Date();
  d.setDate(d.getDate() + 1);
  return d.toISOString().slice(0,10); // YYYY-MM-DD
}

async function probarCobro() {
  const complejoId = getComplejoId();
  if (!complejoId) return alert("Complet√° el ID/slug del complejo primero.");

  // Aseguro que el complejo y canchas est√©n guardados en BD
  const ok = await guardarDatos(true);
  if (!ok) return alert("No se pudo guardar el complejo antes de probar el cobro.");

  const canchaInfo = tomarPrimeraCancha();
  if (!canchaInfo) return alert("Agreg√° al menos una cancha con nombre para probar el cobro.");

  const body = {
    complejoId,
    cancha: canchaInfo.nombre,
    fecha: fechaManiana(),
    hora: "19:00",            // horario de prueba
    titulo: "Prueba de se√±a",
    precio: 10,
    nombre: "Prueba",
    telefono: "000"
  };

  try {
    const r = await fetch(`${backend}/crear-preferencia`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const dj = await r.json();

    if (dj?.init_point) {
      location.href = dj.init_point;
    } else {
      // Mensajes m√°s claros
      const msg = dj?.error || "No se pudo generar la preferencia de prueba.";
      if (/a√∫n no conect√≥ su Mercado Pago/i.test(msg)) {
        alert("Este complejo no tiene MP conectado todav√≠a. Toc√° 'Conectar con Mercado Pago' y volv√© a probar.");
      } else if (/El turno ya est√° tomado/i.test(msg)) {
        alert("El turno de prueba (ma√±ana 19:00) figura ocupado. Cambi√° la se√±a o prob√° otro horario.");
      } else {
        alert(msg);
      }
    }
  } catch (e) {
    console.error(e);
    alert("Error creando preferencia de prueba.");
  }
}

/* ====== EVENTOS ====== */
$("#btnAgregarCancha").onclick = () => { agregarCancha(); saveDraft(); };
$("#btnGuardar").onclick = async () => {
  const ok = await guardarDatos(false);
  if (ok) clearDraft();
};
$("#btnConectar").onclick = conectarMP;
$("#btnProbarMP").onclick = probarCobro;

document.addEventListener("input", e=>{
  if (["id","clave","nombre","ciudad","maps","emailDue√±o","whatsappDue√±o"].includes(e.target.id)) {
    refrescarPreview();
    saveDraft();
    if (e.target.id === "id") {
      localStorage.setItem("complejoId", e.target.value.trim());
      pintarEstadoMP();
    }
  }
});
document.addEventListener("change", e=>{
  if (e.target.closest("#servicios") || e.target.closest("#tbodyHorarios") || e.target.closest("#canchas")){
    refrescarPreview(); saveDraft();
  }
});

/* ====== INIT ====== */
armarHorarios();
armarServicios();
agregarCancha();        // una cancha de ejemplo
refrescarPreview();

window.addEventListener("load", () => {
  const q = new URLSearchParams(location.search);
  const slug = q.get("complejo");
  if (slug) {
    const idEl = $("#id");
    if (idEl && !idEl.value) idEl.value = slug;
    localStorage.setItem("complejoId", slug);
  }

  // Restaurar draft si existe
  loadDraft();

  // Mensaje al volver del OAuth
  if (q.get("mp") === "ok") {
    const msg = $("#msgDatos");
    if (msg) { msg.textContent = "Mercado Pago conectado ‚úÖ (no olvides Guardar datos)"; msg.className = "ok"; }
    // refrescos r√°pidos de estado por si el token tarda un instante en escribirse
    pintarEstadoMP();
    setTimeout(pintarEstadoMP, 1200);
    setTimeout(pintarEstadoMP, 3000);
  } else {
    pintarEstadoMP();
  }
});
</script>
</body>
</html>
