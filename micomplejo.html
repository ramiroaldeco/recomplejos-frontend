<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi Complejo</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f8f8f8;
      color: #333;
    }
    header {
      background-color: #00aa55;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .contenedor {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      margin-top: 20px;
    }
    h2 { color: #00aa55; }
    input, select, button, textarea {
      padding: 10px;
      margin: 10px 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #00aa55;
      color: white;
      cursor: pointer;
      border: none;
    }
    .panel { margin-top: 30px; }

    .imagenes-preview {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      margin-top: 10px;
    }
    .imagenes-preview div { display: flex; flex-direction: column; align-items: center; }
    .imagenes-preview img { height: 150px; border-radius: 10px; }

    .servicios {
      display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;
    }
    .servicios label {
      display: flex; align-items: center; gap: 5px;
      background: #f0f0f0; padding: 8px 12px; border-radius: 20px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #00aa55; color: white; }
    .reservado { background-color: #f44336; color: white; }
    .disponible { background-color: #4CAF50; color: white; }
    .deshabilitado { background-color: #aaa; color: white; }
    .bloque { background-color: #ffd700; color: black; }

    /* ===== Tabla de turnos (admin) ===== */
    .tabla-scroll{
      max-height: 520px;     /* alto visible; aparece scroll si hay muchas filas */
      overflow: auto;        /* scroll X e Y */
      border: 1px solid #e7ecef;
      border-radius: 12px;
    }
    .turnos{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 960px;
      font-size: 14px;
    }
    .turnos th, .turnos td{
      padding: 10px 12px;
      border-bottom: 1px solid #eef2f6;
    }
    .turnos thead th{
      position: sticky; top: 0; background: #0b8457; color: #fff; z-index: 2;
    }
    .turnos th:first-child, .turnos td:first-child{
      position: sticky; left: 0; background: #fff; z-index: 3; font-weight: 600;
    }
    .turnos tbody tr:nth-child(even) td{ background: #fbfcfd; }
    .turnos .deshabilitado{ background:#f1f3f6; color:#7a7f87; text-align:center; }
    .turnos .reservado{ background:#ffe3e3; color:#b42318; font-weight:600; text-align:center; }
    .turnos .disponible{ background:#e8f7ee; color:#136f3a; text-align:center; cursor:pointer; }
    .turnos .disponible:hover{ filter: brightness(0.97); }
    .turnos .btn-mini{
      display:inline-flex; align-items:center; justify-content:center;
      width:32px; height:32px; border-radius:10px; border:0;
      background:#0b8457; color:#fff; cursor:pointer;
    }
    .turnos .btn-mini.secondary{ background:#e53935; }
    .turnos .btn-mini:disabled{ opacity:.5; cursor:not-allowed; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header><h1>Panel del Propietario</h1></header>

  <div class="contenedor" id="loginPanel">
    <h2>Ingresar a tu complejo</h2>
    <select id="complejo">
      <option value="">-- Eleg√≠ tu complejo --</option>
    </select>
    <input type="password" id="clave" placeholder="Contrase√±a" />
    <button onclick="entrarAdmin()">Entrar</button>
  </div>

  <div id="panel" class="contenedor" style="display:none;">
    <h2 id="tituloComplejo"></h2>
    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>

    <!-- Datos del Complejo -->
    <div class="panel">
      <h3>Datos del Complejo</h3>
      <input type="text" id="nombreComplejo" placeholder="Nombre del complejo" />
      <input type="text" id="ciudadComplejo" placeholder="Ciudad" />
      <textarea id="iframeMapa" rows="4" style="width:100%;" placeholder="Pegar c√≥digo iframe del mapa aqu√≠"></textarea>
      <button onclick="guardarDatosGenerales()">Guardar datos del complejo</button>
    </div>

    <!-- Horarios del Complejo -->
    <div class="panel">
      <h3>Horarios del Complejo</h3>
      <table>
        <thead><tr><th>D√≠a</th><th>Desde</th><th>Hasta</th></tr></thead>
        <tbody id="tablaHorarios"></tbody>
      </table>
      <button onclick="guardarHorarios()">Guardar horarios</button>
    </div>

    <!-- Fotos del Complejo -->
    <div class="panel">
      <h3>Fotos del Complejo</h3>
      <input type="file" id="imagenes" multiple accept="image/*" />
      <button onclick="alert('Sub√≠ tus im√°genes a https://postimg.cc y peg√° los enlaces')">Guardar Im√°genes</button>
      <div class="imagenes-preview" id="preview"></div>
    </div>

    <!-- Servicios -->
    <div class="panel">
      <h3>Servicios ofrecidos</h3>
      <div class="servicios" id="listaServicios">
        <label><input type="checkbox" value="Duchas" /> Duchas</label>
        <label><input type="checkbox" value="Vestuarios" /> Vestuarios</label>
        <label><input type="checkbox" value="Quincho" /> Quincho</label>
        <label><input type="checkbox" value="Parrilla" /> Parrilla</label>
        <label><input type="checkbox" value="Wifi" /> Wifi</label>
        <label><input type="checkbox" value="Bar" /> Bar</label>
        <label><input type="checkbox" value="Buffet" /> Buffet</label>
        <label><input type="checkbox" value="Ba√±os" /> Ba√±os</label>
        <label><input type="checkbox" value="Estacionamiento" /> Estacionamiento</label>
      </div>
      <button onclick="guardarServicios()">Guardar servicios</button>
    </div>

    <!-- Canchas -->
    <div class="panel">
      <h3>Canchas del Complejo</h3>
      <div id="listaCanchas"></div>
      <button onclick="agregarCancha()">+ Agregar Cancha</button>
      <button onclick="guardarCanchas()">Guardar Canchas</button>
    </div>

    <!-- Turnos -->
    <div class="panel">
      <h3>Turnos del Complejo</h3>
      <div id="tablasTurnosCanchas"></div>
    </div>
  </div>

  <script>
  // ===== Helpers horarios (incluye trasnoche) =====
  function canonDia(d){ return (d||"").normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
  function getHorario(horarios, nombreDia){ return horarios[nombreDia] || horarios[canonDia(nombreDia)] || {}; }
  function entre(hora, desde, hasta){
    if(!desde || !hasta) return false;
    return (desde <= hasta) ? (hora >= desde && hora <= hasta) : (hora >= desde || hora <= hasta);
  }

  // ===== Estado global =====
  const backendUrl = "https://recomplejos-backend.onrender.com";
  let complejoActivo = "";
  const diasSemana = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];

  // ===== Poblar <select> con complejos =====
  async function poblarSelectComplejos() {
    try {
      const data = await fetch(`${backendUrl}/datos_complejos`).then(r => r.json());
      const sel = document.getElementById("complejo");
      const previo = localStorage.getItem("complejoActivo") || "";

      sel.innerHTML = '<option value="">-- Eleg√≠ tu complejo --</option>';

      const items = Object.entries(data).sort((a,b) => {
        const an = (a[1].nombre || a[0]).toLocaleLowerCase();
        const bn = (b[1].nombre || b[0]).toLocaleLowerCase();
        return an.localeCompare(bn, "es", { sensitivity: "base" });
      });

      for (const [slug, cfg] of items) {
        const opt = document.createElement("option");
        opt.value = slug;
        opt.textContent = `${cfg.nombre || slug}${cfg.ciudad ? ` (${cfg.ciudad})` : ""}`;
        sel.appendChild(opt);
      }

      if (previo && data[previo]) sel.value = previo;
    } catch (e) {
      console.error("No se pudieron cargar los complejos", e);
    }
  }

  // ===== Login y carga inicial =====
  window.addEventListener("load", () => {
    document.getElementById("panel").style.display = "none";
    document.getElementById("loginPanel").style.display = "block";
    poblarSelectComplejos();
  });

  let reservasActuales = {};
  function cargarReservas() {
    return fetch(`${backendUrl}/reservas`)
      .then(res => res.json())
      .then(data => { reservasActuales = data; });
  }

  function entrarAdmin() {
    const complejo = document.getElementById("complejo").value;
    const clave = document.getElementById("clave").value;

    fetch(`${backendUrl}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ complejo, password: clave })
    })
    .then(res => { if (!res.ok) throw new Error("Login fallido"); return res.json(); })
    .then(() => {
      complejoActivo = complejo;
      localStorage.setItem("complejoActivo", complejo);
      document.getElementById("panel").style.display = "block";
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("tituloComplejo").textContent = `Administraci√≥n: ${complejo}`;
      cargarDatos();
      cargarReservas().then(cargarTurnos);
    })
    .catch(() => alert("Contrase√±a incorrecta"));
  }

  function cerrarSesion() { location.reload(); }

  // ===== Datos, horarios, servicios, canchas =====
  function cargarDatos() {
    fetch(`${backendUrl}/datos_complejos`)
      .then(res => res.json())
      .then(data => {
        const info = data[complejoActivo] || {};
        document.getElementById("nombreComplejo").value = info.nombre || "";
        document.getElementById("ciudadComplejo").value = info.ciudad || "";
        document.getElementById("iframeMapa").value = info.maps || "";

        document.querySelectorAll("#listaServicios input").forEach(cb => {
          cb.checked = (info.servicios || []).includes(cb.value);
        });

        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        (info.imagenes || []).forEach((src, index) => {
          const div = document.createElement("div");
          const img = document.createElement("img"); img.src = src;
          const btn = document.createElement("button"); btn.textContent = "Eliminar";
          btn.onclick = () => eliminarImagen(index);
          div.appendChild(img); div.appendChild(btn); preview.appendChild(div);
        });

        const horarios = info.horarios || {};
        const tabla = document.getElementById("tablaHorarios");
        tabla.innerHTML = "";
        const ordenDias = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
        ordenDias.forEach(dia => {
          const fila = document.createElement("tr");
          const desde = document.createElement("select");
          const hasta = document.createElement("select");
          for (let h = 0; h <= 23; h++) {
            const hora = h.toString().padStart(2, "0") + ":00";
            desde.appendChild(new Option(hora, hora));
            hasta.appendChild(new Option(hora, hora));
          }
          desde.value = horarios?.[dia]?.desde || "18:00";
          hasta.value = horarios?.[dia]?.hasta || "23:00";
          fila.innerHTML = `<td>${dia}</td>`;
          const td1 = document.createElement("td"); td1.appendChild(desde);
          const td2 = document.createElement("td"); td2.appendChild(hasta);
          fila.appendChild(td1); fila.appendChild(td2);
          tabla.appendChild(fila);
        });

        mostrarCanchas(info.canchas || []);
      });
  }

  function mostrarCanchas(canchas) {
    const lista = document.getElementById("listaCanchas");
    lista.innerHTML = "";
    canchas.forEach((cancha, index) => {
      const div = document.createElement("div");
      div.innerHTML = `
        <label>Nombre de la cancha</label><br/>
        <input id="nombreCancha${index}" value="${cancha.nombre || ''}" placeholder="Nombre de la cancha" /><br/>
        <label>Precio total de la cancha</label><br/>
        <input id="precioTotal${index}" value="${cancha.precioTotal || ''}" placeholder="Precio total" /><br/>
        <label>Precio por jugador</label><br/>
        <input id="precioPorJugador${index}" value="${cancha.precioPorJugador || ''}" placeholder="Precio por jugador" /><br/>
        <label>Cantidad de jugadores</label><br/>
        <input id="jugadores${index}" value="${cancha.jugadores || ''}" placeholder="Cantidad de jugadores" /><br/>
        <label>Se√±a obligatoria por turno</label><br/>
        <input id="senia${index}" value="${cancha.senia || ''}" placeholder="Ej: 3000" /><br/>
        <button onclick="eliminarCancha(${index})">Eliminar</button>
        <hr/>
      `;
      lista.appendChild(div);
    });
  }

  function guardarCanchas() {
    const divs = document.querySelectorAll("#listaCanchas > div");
    const nuevas = [];
    divs.forEach((div, i) => {
      nuevas.push({
        nombre: document.getElementById(`nombreCancha${i}`).value,
        precioTotal: document.getElementById(`precioTotal${i}`).value,
        precioPorJugador: document.getElementById(`precioPorJugador${i}`).value,
        jugadores: document.getElementById(`jugadores${i}`).value,
        senia: document.getElementById(`senia${i}`).value
      });
    });
    guardarEnJson({ canchas: nuevas });
    alert("Canchas guardadas");
    cargarTurnos();
  }

  function agregarCancha() {
    fetch(`${backendUrl}/datos_complejos`)
      .then(r => r.json())
      .then(json => {
        const info = json[complejoActivo] || {};
        info.canchas = info.canchas || [];
        info.canchas.push({ nombre: "", precioTotal: "", precioPorJugador: "", jugadores: "", senia: "" });
        guardarEnJson({ canchas: info.canchas });
        cargarDatos();
      });
  }

  function guardarHorarios() {
    const tabla = document.querySelectorAll("#tablaHorarios tr");
    const nuevos = {};
    tabla.forEach(fila => {
      const dia = fila.children[0].textContent;
      const desde = fila.children[1].querySelector("select").value;
      const hasta = fila.children[2].querySelector("select").value;
      nuevos[dia] = { desde, hasta };
    });
    guardarEnJson({ horarios: nuevos });
    alert("Horarios guardados");
    cargarTurnos();
  }

  function guardarDatosGenerales() {
    const nombre = document.getElementById("nombreComplejo").value;
    const ciudad = document.getElementById("ciudadComplejo").value;
    const maps = document.getElementById("iframeMapa").value;
    guardarEnJson({ nombre, ciudad, maps });
    alert("Datos generales guardados");
  }

  function guardarServicios() {
    const seleccionados = Array.from(document.querySelectorAll("#listaServicios input:checked")).map(cb => cb.value);
    guardarEnJson({ servicios: seleccionados });
    alert("Servicios guardados");
  }

  function eliminarCancha(index) {
    fetch(`${backendUrl}/datos_complejos`)
      .then(r => r.json())
      .then(json => {
        const info = json[complejoActivo] || {};
        info.canchas.splice(index, 1);
        guardarEnJson({ canchas: info.canchas });
        cargarDatos();
      });
  }

  function eliminarImagen(index) {
    fetch(`${backendUrl}/datos_complejos`)
      .then(r => r.json())
      .then(json => {
        const info = json[complejoActivo] || {};
        info.imagenes.splice(index, 1);
        guardarEnJson({ imagenes: info.imagenes });
        cargarDatos();
      });
  }

  function guardarEnJson(parcial) {
    fetch(`${backendUrl}/datos_complejos`)
      .then(res => res.json())
      .then(json => {
        json[complejoActivo] = { ...json[complejoActivo], ...parcial };
        fetch(`${backendUrl}/guardarDatos`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(json)
        });
      });
  }

  // ===== Turnos (render) =====
  function cargarTurnos() {
    fetch(`${backendUrl}/datos_complejos`)
      .then(r => r.json())
      .then(json => {
        const info = json[complejoActivo] || {};
        fetch(`${backendUrl}/reservas`)
          .then(r => r.json())
          .then(reservas => {
            const container = document.getElementById("tablasTurnosCanchas");
            container.innerHTML = "";

            const canchas = info.canchas || [];
            for (const cancha of canchas) {
              const div = document.createElement("div");
              const idTabla = `turnosAdmin-${(cancha.nombre || 'cancha').replace(/\s+/g, '_')}`;
              div.innerHTML = `<h3>${cancha.nombre || "Cancha"}</h3><div id="${idTabla}"></div>`;
              container.appendChild(div);
              renderTablaTurnosAdmin(info, cancha, reservas, idTabla);
            }
          });
      });
  }

  function renderTablaTurnosAdmin(info, cancha, reservas, contenedorId) {
    const horarios = info.horarios || {};
    const hoy = new Date();
    const container = document.getElementById(contenedorId);

    let html = '<table class="turnos"><thead><tr><th>Hora</th>';

    const dias = [];
    for (let i = 0; i < 7; i++) {
      const fecha = new Date();
      fecha.setDate(hoy.getDate() + i);
      const nombreDia = diasSemana[fecha.getDay()];
      const dia = String(fecha.getDate()).padStart(2, '0');
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      dias.push({ nombre: nombreDia, fecha: `${dia}/${mes}`, fechaReal: fecha });
      html += `<th>${nombreDia}<br>${dia}/${mes}</th>`;
    }

    html += '</tr></thead><tbody>';

    for (let h = 0; h < 24; h++) {
      const hora = `${String(h).padStart(2, '0')}:00`;

      const mostrarFila = dias.some(d => {
        const hDia = getHorario(horarios, d.nombre);
        return entre(hora, hDia.desde || '18:00', hDia.hasta || '23:00');
      });
      if (!mostrarFila) continue;

      html += `<tr><td>${hora}</td>`;

      for (const d of dias) {
        const clave = `${complejoActivo}-${cancha.nombre}-${d.nombre}-${hora}`;
        const turno = reservas[clave];

        const hDia = getHorario(horarios, d.nombre);
        const desde = hDia.desde || '18:00';
        const hasta = hDia.hasta || '23:00';

        if (!entre(hora, desde, hasta)) {
          html += '<td class="deshabilitado">Cerrado</td>';
        } else if (turno?.bloqueado) {
          html += `<td class="bloque">Bloqueado<br>
                     <button class="btn-mini secondary" onclick="desbloquearTurno('${clave}')">‚úîÔ∏è</button>
                   </td>`;
        } else if (turno) {
          html += `<td class="reservado">
                     ${turno.nombre}<br><small>${turno.telefono || ''}</small><br>
                     <button class="btn-mini secondary" onclick="cancelarTurno('${clave}')">‚ùå</button>
                   </td>`;
        } else {
          html += `<td class="disponible">
                     Disponible<br>
                     <button class="btn-mini" onclick="bloquearTurno('${clave}')">üö´</button>
                   </td>`;
        }
      }

      html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = `<div class="tabla-scroll">${html}</div>`;
  }

  // ===== Acciones de reservas (admin) =====
  function cancelarTurno(clave) {
    if (!confirm("¬øSeguro que quer√©s cancelar esta reserva?")) return;
    fetch(`${backendUrl}/reservas`)
      .then(r => r.json())
      .then(json => { delete json[clave]; guardarReservas(json); });
  }

  function bloquearTurno(clave) {
    fetch(`${backendUrl}/reservas`)
      .then(r => r.json())
      .then(json => { json[clave] = { bloqueado: true }; guardarReservas(json); });
  }

  function desbloquearTurno(clave) {
    fetch(`${backendUrl}/reservas`)
      .then(r => r.json())
      .then(json => { delete json[clave]; guardarReservas(json); });
  }

  function guardarReservas(json) {
    fetch(`${backendUrl}/guardarReservas`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(json)
    }).then(() => {
      alert("Reserva actualizada");
      cargarTurnos();
    });
  }
  </script>
</body>
</html>















